<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>팀 매칭 및 결과 기록</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
    <style>
        .player-selection { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .player-card { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; padding: 10px; width: calc(20% - 12px); /* gap 고려하여 약간 줄임 */ min-width: 150px; cursor: pointer; transition: background-color 0.3s; box-sizing: border-box; }
        .player-card:hover { background-color: #eee; }
        .player-card.selected { background-color: #d4edda; border-color: #c3e6cb; }
        .player-card h3 { font-size: 1em; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .player-card .tier { font-weight: bold; color: #2c3e50; font-size: 0.9em; }
        .player-card .position { display: inline-block; padding: 2px 5px; background-color: #3498db; color: white; border-radius: 3px; margin-top: 3px; font-size: 0.75em; }
        .player-card .match-score, .player-card .record { font-size: 0.8em; color: #555; margin-top: 3px; }

        .position-TOP { background-color: #e74c3c; } .position-JUNGLE { background-color: #27ae60; }
        .position-MID { background-color: #f1c40f; color: #333;} .position-ADC { background-color: #e67e22; }
        .position-SUPPORT { background-color: #3498db; } .position-ALL { background-color: #8e44ad; }

        .selected-counter { margin: 15px 0; font-weight: bold; }

        .recent-matches-section { margin-top: 30px; }
        .recent-matches-section h2 { margin-bottom: 10px; }
        .match-item-link { text-decoration: none; color: inherit; display: block; margin-bottom: 8px; }
        .match-item-link:hover .match-item { background-color: #e9ecef; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .match-item { background-color: #fdfdfd; border: 1px solid #e0e0e0; border-radius: 4px; padding: 12px; transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .match-date { font-size: 0.85em; color: #777; margin-bottom: 6px; }
        .match-details { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
        .match-teams-summary { flex-grow: 1; min-width: 180px; font-size: 0.9em; line-height: 1.3; }
        .match-winner-summary { font-weight: bold; color: #27ae60; font-size: 0.9em; }
        .match-pending-summary { color: #e67e22; font-style: italic; font-size: 0.9em; }

        #multiMatchResults { margin-top: 20px; padding: 10px; background-color: #f0f8ff; border-radius: 5px;}
        #multiMatchResults h3 { margin-bottom: 10px;}
        #multiMatchResults a { display: block; margin-bottom: 5px; color: #007bff; text-decoration: none;}
        #multiMatchResults a:hover { text-decoration: underline;}

    </style>
</head>
<body>
    <div class="container">
        <h1>팀 매칭 생성</h1>

        <div class="match-maker">
            <h2>플레이어 선택</h2>
            <p class="subtitle">매칭할 플레이어를 선택하세요 (10명 또는 10의 배수)</p>
            <div class="selected-counter">선택된 플레이어: <span id="selectedCount">0</span>명</div>
            <div class="player-selection" id="playerSelection">
                {% for player in players %}
                    <div class="player-card" data-id="{{ player.id }}">
                        <h3>{{ player.nickname }}</h3>
                        <div class="tier">
                            {{ player.tier.value }}
                            {% if player.tier.value not in ['MASTER', 'GRANDMASTER', 'CHALLENGER'] %}
                                {% if player.division == 1 %}I{% elif player.division == 2 %}II{% elif player.division == 3 %}III{% elif player.division == 4 %}IV{% endif %}
                                ({{player.lp}}LP)
                            {% else %}
                                {{ player.division }} 점수
                            {% endif %}
                        </div>
                        <div>
                            <span class="position {{ player.position.value }}">{{ player.position.value }}</span>
                            {% if player.sub_position %}
                                <span class="position {{ player.sub_position.value }}" style="background-color: #7f8c8d;">{{ player.sub_position.value }}</span>
                            {% endif %}
                        </div>
                        <div class="match-score">매칭: {{ "%.0f"|format(player.match_score) }}</div>
                        <div class="record">{{ player.win_count }}승 {{ player.lose_count }}패</div>
                    </div>
                {% endfor %}
                 {% if not players %}
                    <p>등록된 플레이어가 없습니다. <a href="{{url_for('player_management_page')}}">플레이어 관리</a> 페이지에서 먼저 플레이어를 등록해주세요.</p>
                {% elif players|length < 10 %}
                     <p>팀 매칭을 위해서는 최소 10명의 플레이어가 등록되어 있어야 합니다. 현재 {{ players|length }}명 등록됨.</p>
                {% endif %}
            </div>
            <button id="createMatchBtn" class="btn btn-primary" disabled>팀 매칭 시작 및 상세 보기</button>
            <div id="multiMatchResults" style="display:none;">
                <h3>생성된 매치 목록</h3>
                <div id="multiMatchLinks"></div>
            </div>
        </div>

        <div class="recent-matches-section">
            <h2>최근 매치 목록 (클릭 시 상세 및 결과 입력)</h2>
            <div id="recentMatchesList">
                {% if recent_matches %}
                    {% for match in recent_matches %}
                    <a href="{{ url_for('match_detail_page', match_id=match.id) }}" class="match-item-link">
                        <div class="match-item">
                            <div class="match-date">{{ match.match_date.strftime('%Y-%m-%d %H:%M') }}</div>
                            <div class="match-details">
                                <div class="match-teams-summary">
                                    블루 (Avg 티어: {{ "%.0f"|format(match.blue_team_avg_score) }}) vs
                                    레드 (Avg 티어: {{ "%.0f"|format(match.red_team_avg_score) }})
                                    <br>밸런스(티어): {{ "%.1f"|format(match.balance_score) }}
                                </div>
                                {% if match.is_completed %}
                                <span class="match-winner-summary">승리: {{ "블루팀" if match.winner == "BLUE" else "레드팀" }}</span>
                                {% else %}
                                <span class="match-pending-summary">결과 대기중</span>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                {% else %}
                    <p>진행된 매치가 없습니다.</p>
                {% endif %}
            </div>
        </div>

        <div class="actions">
            <a href="{{ url_for('home') }}" class="btn">메인으로 돌아가기</a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const playerCards = document.querySelectorAll('.player-card');
            const selectedCountSpan = document.getElementById('selectedCount');
            const createMatchBtn = document.getElementById('createMatchBtn');
            const multiMatchResultsDiv = document.getElementById('multiMatchResults');
            const multiMatchLinksDiv = document.getElementById('multiMatchLinks');

            let selectedPlayers = [];
            const minPlayersRequired = 10; // 최소 플레이어 수

            // 초기 버튼 상태 업데이트
            updateCreateMatchButtonState();

            function updateCreateMatchButtonState() {
                const numSelected = selectedPlayers.length;
                if (numSelected >= minPlayersRequired && numSelected % 10 === 0) {
                    createMatchBtn.disabled = false;
                    createMatchBtn.title = "";
                } else {
                    createMatchBtn.disabled = true;
                    if (numSelected < minPlayersRequired) {
                         createMatchBtn.title = `최소 ${minPlayersRequired}명의 플레이어가 필요합니다.`;
                    } else if (numSelected % 10 !== 0) {
                        createMatchBtn.title = "플레이어 수는 10의 배수여야 합니다.";
                    }
                }
            }


            playerCards.forEach(card => {
                card.addEventListener('click', function() {
                    const playerId = parseInt(this.dataset.id);
                    this.classList.toggle('selected');

                    if (this.classList.contains('selected')) {
                        selectedPlayers.push(playerId);
                    } else {
                        selectedPlayers = selectedPlayers.filter(id => id !== playerId);
                    }

                    selectedCountSpan.textContent = selectedPlayers.length;
                    updateCreateMatchButtonState();
                });
            });

            if(createMatchBtn){
                createMatchBtn.addEventListener('click', async function() {
                    this.disabled = true;
                    this.textContent = "매칭 중...";
                    multiMatchResultsDiv.style.display = 'none'; // 이전 결과 숨기기
                    multiMatchLinksDiv.innerHTML = ''; // 이전 링크 지우기

                    const numSelected = selectedPlayers.length;
                    let apiUrl = "";

                    // API 엔드포인트 결정 (main.py의 MatchCreate 스키마를 사용하도록 통일)
                    if (numSelected === 10) {
                        apiUrl = `{{ url_for('create_match_api') }}`;
                    } else if (numSelected > 10 && numSelected % 10 === 0) {
                        apiUrl = `{{ url_for('create_multiple_matches_api') }}`;
                    } else { // 이 경우는 버튼 활성화 로직에서 이미 걸러짐
                        alert("플레이어 수는 10명 또는 10의 배수여야 합니다.");
                        this.disabled = false;
                        this.textContent = "팀 매칭 시작 및 상세 보기";
                        return;
                    }

                    try {
                        // 두 API 모두 payload: schemas.MatchCreate 를 받으므로,
                        // 요청 본문은 { "player_ids": [...] } 형태여야 함.
                        const payload = { player_ids: selectedPlayers };

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(payload),
                            credentials: 'same-origin'
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({ detail: `서버 오류: ${response.status} ${response.statusText}. 응답이 JSON이 아닙니다.` }));
                            throw new Error(errorData.detail || `팀 매칭 중 오류 (상태 코드: ${response.status})`);
                        }

                        const responseData = await response.json();

                        if (numSelected === 10) { // 단일 매치 생성 결과 (MatchWithTeams 객체)
                            window.location.href = `{{ url_for('match_detail_page', match_id=0) }}`.replace('/0', '/' + responseData.id);
                        } else { // 여러 매치 생성 결과 (List[MatchWithTeams] 객체)
                            if (responseData && responseData.length > 0) {
                                multiMatchResultsDiv.style.display = 'block';
                                responseData.forEach((match, index) => {
                                   const link = document.createElement('a');
                                   link.href = `{{ url_for('match_detail_page', match_id=0) }}`.replace('/0', '/' + match.id);
                                   link.textContent = `그룹 ${index + 1} 매치 (ID: ${match.id}) - 상세 및 결과 입력`;
                                   link.target = "_blank"; // 새 탭에서 열기
                                   multiMatchLinksDiv.appendChild(link);
                                   multiMatchLinksDiv.appendChild(document.createElement('br'));
                                });
                                alert(`${responseData.length}개의 매치가 생성되었습니다. 아래 목록에서 각 매치 상세 정보를 확인하세요.`);
                                // 페이지 새로고침 또는 최근 매치 목록 업데이트 로직 추가 가능
                                // window.location.reload(); // 간단하게는 새로고침
                            } else {
                                alert("매치가 생성되었으나, 반환된 매치 데이터가 없습니다.");
                            }
                        }

                    } catch (error) {
                        console.error("팀 매칭 API 호출 오류:", error);
                        alert(error.message || '팀 매칭 중 알 수 없는 오류가 발생했습니다.');
                    } finally { // 성공/실패 여부와 관계없이 버튼 상태 복원
                        this.disabled = false;
                        this.textContent = "팀 매칭 시작 및 상세 보기";
                        updateCreateMatchButtonState(); // 선택된 플레이어 수에 따라 버튼 다시 활성화/비활성화
                    }
                });
            }
        });
    </script>
</body>
</html>